<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/><meta name="exporter-version" content="Evernote Mac 9.2.0 (458672)"/><meta name="author" content="林"/><meta name="created" content="2019-08-22 17:04:06 +0000"/><meta name="source" content="desktop.mac"/><meta name="updated" content="2019-09-11 12:16:56 +0000"/><title>Retrofit网络加载框架</title></head><body><div>配置</div><div>Retrofit:<a href="https://github.com/square/retrofit">https://github.com/square/retrofit</a></div><div>Okhttp<a href="https://github.com/square/okhttp">https://github.com/square/okhttp</a></div><div>网络权限：</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>&lt;uses-permission android:name="android.permission.INTERNET”/&gt;</div></div><div><br/></div><div><span style="font-size: 18px;"><span style="font-size: 18px; font-weight: bold;">Retrofit概念</span></span></div><div><span style="font-size: 14px;">Retrofit是一个网络加载框架，底层使用okhttp封装。</span></div><div><span style="font-size: 14px;">Retrofit优点</span></div><ul><li><div><span style="font-size: 14px;">超级解藕</span></div></li></ul><div>使api接口定义和api接口使用不那么藕合</div><ul><li><div>配置不同的HttpClient来实现网络请求</div></li><li><div>支持同步与异步</div></li><li><div>支持使用反序列化工具来解析数据</div></li></ul><div><br/></div><div>完整的URL = .baseUrl + Path</div><div>通常使用第三种配置方法。</div><div><img src="Retrofit%E7%BD%91%E7%BB%9C%E5%8A%A0%E8%BD%BD%E6%A1%86%E6%9E%B6.resources/6B3017A2-024C-4FF6-83EC-58629C667AC1.png" height="399" width="480"/><br/></div><div><br/></div><div>注解：</div><div><img src="Retrofit%E7%BD%91%E7%BB%9C%E5%8A%A0%E8%BD%BD%E6%A1%86%E6%9E%B6.resources/16F97A95-020A-4319-B98D-117CB831B52C.png" height="850" width="1000"/><br/></div><div>网络请求方法：</div><div><img src="Retrofit%E7%BD%91%E7%BB%9C%E5%8A%A0%E8%BD%BD%E6%A1%86%E6%9E%B6.resources/67CD2489-4541-4290-A2C2-DFEF513206D9.png" height="385" width="870"/><br/></div><div>标记：</div><div><img src="Retrofit%E7%BD%91%E7%BB%9C%E5%8A%A0%E8%BD%BD%E6%A1%86%E6%9E%B6.resources/163CE3BB-7F88-4460-AE65-FD1127834485.png" height="222" width="870"/><br/></div><div>网络请求参数：</div><div><img src="Retrofit%E7%BD%91%E7%BB%9C%E5%8A%A0%E8%BD%BD%E6%A1%86%E6%9E%B6.resources/FCB8DC67-1B79-41D8-8936-70744B8B9FFA.png" height="447" width="870"/><br/></div><div><br/></div><div><span style="font-size: 18px;"><span style="font-size: 18px; font-weight: bold;">Retrofit 使用测试：</span></span></div><div><br/></div><div>Get请求</div><div> ResponseBody 是Retrofit的原始数据类，可以直接查看返回数据的字符串。</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>interface Api {</div><div>    @GET("getJoke")</div><div>    fun getNetData(@Query("page") page: Int,@Query("count") count:Int,@Query("type") type:String):Call&lt;ResponseBody&gt;</div><div>}</div></div><div> </div><div>异步网络请求 <span style="color: rgb(255, 38, 0);">enqueue</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>private fun getDataFromNet(page:Int,count:Int,type:String = "video",url:String = "https://api.apiopen.top/"){</div><div>    val retrofit = Retrofit.Builder().apply {</div><div>        baseUrl(url)</div><div>    }.build()</div><div>    val api = retrofit.create(Api::class.java)</div><div>    val call = api.getNetData(page,count,type)</div><div>    call.enqueue(object : Callback&lt;ResponseBody&gt;{</div><div>        override fun onFailure(call: Call&lt;ResponseBody&gt;, t: Throwable) {</div><div>            log("失败")</div><div>        }</div><div>        override fun onResponse(call: Call&lt;ResponseBody&gt;, response: Response&lt;ResponseBody&gt;) {</div><div>            log("成功： \n" + response.body().toString() )</div><div>        }</div><div>    })</div><div>}</div></div><div>同步网络请求 <span style="color: rgb(255, 38, 0);">execute</span></div><div><span style="caret-color: rgb(255, 38, 0);">不能在主线程调用</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>private fun getDataFromNet(page:Int,count:Int,type:String = "video",url:String = "https://api.apiopen.top/"){</div><div>    val retrofit = Retrofit.Builder().apply {</div><div>        baseUrl(url)</div><div>    }.build()</div><div>    val api = retrofit.create(Api::class.java)</div><div>    val call = api.getNetData(page,count,type)</div><div>    val data = call.execute()</div><div>    log(data.body().toString())</div><div>}</div></div><div><br/></div><div>POST网络请求</div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>interface Api {</div><div>    @POST("getJoke")</div><div>    fun getNetData(@Query("page") page: Int,@Query("count") count:Int,@Query("type") type:String):Call&lt;ResponseBody&gt;</div><div>}</div></div><div><br/></div><div>Retrofit支持多种解析器</div><div>使用Gson解析：<span style="color: rgb(4, 50, 255);">addConvererFactory(GsonConverterFactory.create( ))</span></div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"/><col style="width: 352px;"/></colgroup><tbody><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>数据解析器</div></td><td style="width: 352px; padding: 8px; border: 1px solid;"><div>Gradle依赖</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>Gson </div></td><td style="width: 352px; padding: 8px; border: 1px solid;"><div>com.squareup.retrofit2:converter-gson:2.0.2 </div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>Jackson </div></td><td style="width: 352px; padding: 8px; border: 1px solid;"><div>com.squareup.retrofit2:converter-jackson:2.0.2 </div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>Simple XML </div></td><td style="width: 352px; padding: 8px; border: 1px solid;"><div>com.squareup.retrofit2:converter-simplexml:2.0.2 </div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>Protobuf </div></td><td style="width: 352px; padding: 8px; border: 1px solid;"><div>com.squareup.retrofit2:converter-protobuf:2.0.2 </div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>Moshi </div></td><td style="width: 352px; padding: 8px; border: 1px solid;"><div>com.squareup.retrofit2:converter-moshi:2.0.2 </div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>Wire </div></td><td style="width: 352px; padding: 8px; border: 1px solid;"><div>com.squareup.retrofit2:converter-wire:2.0.2 </div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>Scalars </div></td><td style="width: 352px; padding: 8px; border: 1px solid;"><div>com.squareup.retrofit2:converter-scalars:2.0.2 </div></td></tr></tbody></table><div style="letter-spacing: normal; white-space: normal; word-spacing: 0px;"><br/></div><div>retrofit支持多种适配器</div><div>使用 RxJava：<span style="color: rgb(4, 50, 255);">addCallAdapterFactory(RxJavaCallAdapterFactory.create( ))</span></div><table style="border-collapse: collapse; min-width: 100%;"><colgroup><col style="width: 130px;"/><col style="width: 359px;"/></colgroup><tbody><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>网络请求适配器</div></td><td style="width: 359px; padding: 8px; border: 1px solid;"><div>Gradle依赖</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>Guava </div></td><td style="width: 359px; padding: 8px; border: 1px solid;"><div>com.squareup.retrofit2:adapter-guava:2.0.2 </div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>Java8 </div></td><td style="width: 359px; padding: 8px; border: 1px solid;"><div>com.squareup.retrofit2:adapter-java8:2.0.2 </div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>RxJava </div></td><td style="width: 359px; padding: 8px; border: 1px solid;"><div>com.squareup.retrofit2:adapter-rxjava:2.0.2 </div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>RxJava2</div></td><td style="width: 359px; padding: 8px; border: 1px solid;"><div>com.squareup.retrofit2:adapter-rxjava2:2.3</div></td></tr><tr><td style="width: 130px; padding: 8px; border: 1px solid;"><div>Kotlin协程</div></td><td style="width: 359px; padding: 8px; border: 1px solid;"><div>androidx.lifecycle:lifecycle-viewmodel-ktx:2.2.0-alpha04</div></td></tr></tbody></table><div style="letter-spacing: normal; white-space: normal; word-spacing: 0px;"><span style="color: rgb(0, 0, 0); font-family: -webkit-standard; font-variant-caps: normal;">RxJava2 + Retrofit + Gson :</span></div><div style="box-sizing: border-box; padding: 8px; font-family: Monaco, Menlo, Consolas, &quot;Courier New&quot;, monospace; font-size: 12px; color: rgb(51, 51, 51); border-top-left-radius: 4px; border-top-right-radius: 4px; border-bottom-right-radius: 4px; border-bottom-left-radius: 4px; background-color: rgb(251, 250, 248); border: 1px solid rgba(0, 0, 0, 0.14902);-en-codeblock:true;"><div>private fun getDataFromNet(url:String = "https://www.apiopen.top/"){</div><div>    val retrofit = Retrofit.Builder().apply {</div><div>        baseUrl(url)</div><div>        addConverterFactory(GsonConverterFactory.create())</div><div>        addCallAdapterFactory(RxJava2CallAdapterFactory.create())</div><div>    }.build()</div><div>    val api = retrofit.create(Api::class.java)</div><div>    api.getNetData().apply {</div><div>        subscribeOn(Schedulers.io())</div><div>            .observeOn(AndroidSchedulers.mainThread())</div><div>            .subscribe(object :Observer&lt;NewsBean&gt;{</div><div>            override fun onComplete() {</div><div>                log("onComplete")</div><div>            }</div><div><div><br/></div><div><br/></div></div><div>            override fun onSubscribe(d: Disposable) {</div><div>                log("onSubscribe")</div><div>            }</div><div><div><br/></div><div><br/></div></div><div>            override fun onNext(t: NewsBean) {</div><div>                log("onNext"+t.getNews())</div><div>            }</div><div><div><br/></div><div><br/></div></div><div>            override fun onError(e: Throwable) {</div><div>                log("onError")</div><div>            }</div><div><div><br/></div><div><br/></div></div><div>        })</div><div>    }</div><div>}</div></div><div><br/></div></body></html>